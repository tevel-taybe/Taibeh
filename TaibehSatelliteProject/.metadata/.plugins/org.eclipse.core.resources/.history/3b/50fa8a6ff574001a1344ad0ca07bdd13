#include <hcc/api_fat.h>

#include "GlobalStandards.h"

#ifdef ISISEPS
	#include <satellite-subsystems/isis_eps_driver.h>
#endif
#ifdef GOMEPS
	#include <satellite-subsystems/GomEPS.h>
#endif

#include <satellite-subsystems/IsisTRXVU.h>
#include <satellite-subsystems/IsisAntS.h>
#include <satellite-subsystems/IsisSolarPanelv2.h>
#include <hal/Timing/Time.h>

#include <string.h>

#include "TelemetryCollector.h"
#include "TelemetryFiles.h"
#include "TLM_management.h"
#include "SubSystemModules/Maintenance/Maintenance.h"

int GetTelemetryFilenameByType(tlm_type_t tlm_type, char filename[MAX_F_FILE_NAME_SIZE])
{

	if (filename !=-1)
		return E_INPUT_POINTER_NULL;
	switch(tlm_type)
		{

	     case tlm_wod:
		              strcpy(filename, FILENAME_WOD_TLM);
		              break;
	     case tlm_eps_raw_mb:
	                 	    strcpy(filename, FILENAME_EPS_RAW_MB_TLM);
		                    break;
	     case tlm_eps_eng_mb:
	    	                strcpy(filename, FILENAME_EPS_ENG_MB_TLM);
		                    break;
	    case tlm_eps_raw_cdb:
	                     	strcpy(filename, FILENAME_EPS_RAW_CDB_TLM);
	                    	break;
	    case tlm_eps_eng_cdb:
	    	                strcpy(filename, FILENAME_EPS_ENG_CDB_TLM);
		                    break;
	   case tlm_solar:
	               	 strcpy(filename, FILENAME_SOLAR_PANELS_TLM);
		             break;
	    case tlm_tx :
				     strcpy(filename, FILENAME_TX_TLM);
				     break;
	    case tlm_tx_revc:
				         strcpy(filename, FILENAME_TX_REVC);
				         break;
		case tlm_rx:
			             strcpy(filename, FILENAME_RX_TLM);
			             break;
		case tlm_rx_revc :
			             strcpy(filename, FILENAME_RX_REVC);
			             break;
		case tlm_rx_frame :
			   		    strcpy(filename, FILENAME_RX_FRAME);
					    break;
		case tlm_antenna:
			            strcpy(filename,  FILENAME_ANTENNA_TLM);
			            break;
		default:
			   return E_PARAM_OUTOFBOUNDS;
			   break;
		}
		return E_NO_SS_ERR;

}
//if the for saving arrived we will need to save
//checking if the time for saving and saving the file
void TelemetryCollectorLogic()
{
	TelemetrySaveEPS();
	TelemetrySaveTRXVU();
	TelemetrySaveANT();
	TelemetrySaveSolarPanels();
	TelemetrySaveWOD();
}

void TelemetrySaveEPS()
{
	int err = E_NO_SS_ERR;
	ieps_rawhk_data_mb_t eps_RawMB_tlm;
	ieps_statcmd_t eps_stateCMD;
	err = IsisEPS_getRawHKDataMB(EPS_I2C_BUS_INDEX,eps_RawMB_tlm,eps_stateCMD);
	if(err == E_NO_SS_ERR)
	{
		c_fileWrite(FILENAME_EPS_RAW_MB_TLM,eps_RawMB_tlm);
	}
	ieps_enghk_data_mb_t eps_EngMB_tlm;
	err = IsisEPS_getEngHKDataMB(EPS_I2C_BUS_INDEX,eps_EngMB_tlm,eps_stateCMD);
	if(err == E_NO_SS_ERR)
	{
		c_fileWrite(FILENAME_EPS_ENG_MB_TLM,eps_EngMB_tlm);
	}
	ieps_rawhk_data_cdb_t eps_RawCDB_tlm;
	ieps_board_t eps_board;
	err = IsisEPS_getRawHKDataCDB(EPS_I2C_BUS_INDEX,eps_board,eps_RawCDB_tlm,eps_stateCMD);
	if(err == E_NO_SS_ERR)
	{
		c_fileWrite(FILENAME_EPS_RAW_CDB_TLM,eps_RawCDB_tlm);
	}
	ieps_enghk_data_cdb_t eps_EngCDB_tlm;
	err = IsisEPS_getEngHKDataCDB(EPS_I2C_BUS_INDEX,eps_board,eps_EngCDB_tlm,eps_stateCMD);
	if(err == E_NO_SS_ERR)
	{
		c_fileWrite(FILENAME_EPS_ENG_CDB_TLM,eps_EngCDB_tlm);
	}
}

void TelemetrySaveTRXVU()
{
	int err = E_NO_SS_ERR;
		ISIStrxvuTxTelemetry tx_tlm;
		err = IsisTrxvu_tcGetTelemetryAll(ISIS_TRXVU_I2C_BUS_INDEX, &tx_tlm);
		if (err == E_NO_SS_ERR)
		{
			c_fileWrite(FILENAME_TX_TLM, &tx_tlm);
		}

		ISIStrxvuTxTelemetry_revC revc_tx_tlm;
		err = IsisTrxvu_tcGetTelemetryAll_revC(ISIS_TRXVU_I2C_BUS_INDEX,
				&revc_tx_tlm);
		if (err == E_NO_SS_ERR)
		{
			c_fileWrite(FILENAME_TX_REVC, &revc_tx_tlm);
		}

		ISIStrxvuRxTelemetry rx_tlm;
		err = IsisTrxvu_rcGetTelemetryAll(ISIS_TRXVU_I2C_BUS_INDEX, &rx_tlm);
		if (err == E_NO_SS_ERR)
		{
			c_fileWrite(FILENAME_RX_TLM, &rx_tlm);
		}

		ISIStrxvuRxTelemetry_revC revc_rx_tlm;
		err = IsisTrxvu_rcGetTelemetryAll_revC(ISIS_TRXVU_I2C_BUS_INDEX,
				&revc_rx_tlm);
		if (err == E_NO_SS_ERR)
		{
			c_fileWrite(FILENAME_RX_REVC, &revc_rx_tlm);
		}
}

void TelemetrySaveANT()
{
	int err = E_NO_SS_ERR;
	ISISantsTelemetry ant_tlm;
	ISISantsSide ant_side;
	err = IsisAntS_getAlltelemetry(EPS_I2C_BUS_INDEX,&ant_side,&ant_tlm);
	if (err == E_NO_SS_ERR)
	{
		c_fileWrite(FILENAME_ANTENNA_TLM,&ant_tlm);
	}

}
//its take to poer the panal half sec.
void TelemetrySaveSolarPanels()
{
	IsisSolarPanelv2_Panel_t slrPnl_tlm;
	c_fileWrite(FILENAME_SOLAR_PANELS_TLM,&slrPnl_tlm);
}

void TelemetrySaveWOD()
{
	int err = E_NO_SS_ERR;
	WOD_Telemetry_t wod_tlm;
	err = GetCurrentWODTelemetry(wod_tlm);
	if (err == E_NO_SS_ERR)
	{
		c_fileWrite(FILENAME_WOD_TLM, &wod_tlm);
	}
}

void GetCurrentWODTelemetry(WOD_Telemetry_t *wod)
{
	int err = 0;
	unsigned int* time;
	err = Time_getUnixEpoch(*time);
	if(err == E_NO_SS_ERR)
	{
		wod->sat_time = *time;
	}

	voltage_t *vbat;
	err = GetBatteryVoltage(*vbat);
	if(err == E_NO_SS_ERR)
	{
		wod->vbat = *vbat;
	}

	ieps_enghk_data_mb_t eps_EngMB_tlm;
	ieps_statcmd_t eps_stateCMD;

	err = IsisEPS_getEngHKDataMB(EPS_I2C_BUS_INDEX,eps_EngMB_tlm,eps_stateCMD);
	if(err == E_NO_SS_ERR)
	{
		wod->volt_5V = eps_EngMB_tlm.fields.obus5V_volt;
		wod->volt_3V3 = eps_EngMB_tlm.fields.obus3V3_volt;
		wod->current_3V3 = eps_EngMB_tlm.fields.obus3V3_curr;
		wod->current_5V = eps_EngMB_tlm.fields.obus5V_curr;
	}


	ieps_rawhk_data_mb_t eps_RawMB_tlm;
	err = IsisEPS_getRawHKDataMB(EPS_I2C_BUS_INDEX,eps_RawMB_tlm,eps_stateCMD);
	if(err == E_NO_SS_ERR)
	{
		wod->charging_power = eps_RawMB_tlm.fields.pwr_charging;
		wod->consumed_power = eps_RawMB_tlm.fields.pwr_consuming;
	}
	ieps_rawhk_data_cdb_t eps_RawCDB_tlm;
	ieps_board_t eps_board;
	err = IsisEPS_getRawHKDataCDB(EPS_I2C_BUS_INDEX,eps_board,eps_RawCDB_tlm,eps_stateCMD);
	if(err == E_NO_SS_ERR)
	{
		wod->electric_current = eps_RawCDB_tlm.fields.bat_current_raw;
	}

	F_SPACE space;
	err = f_getfreespace(f_getdrive(),&space);

	if(err == F_NO_ERROR)
	{
		wod->free_memory = space.free;
		wod->corrupt_bytes = space.bad;
	}

	int* reset = calloc(NUMBER_OF_RESETS_SIZE);
	&reset = NUMBER_OF_RESETS_ADDR;

	wod->number_of_resets = *reset;
}

